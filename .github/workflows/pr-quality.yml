name: Pull Request Code Quality

on:
  pull_request:
    branches: [ "main", "develop" ]
    types: [opened, synchronize, reopened]

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  lint-and-format:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Check EditorConfig compliance
      run: |
        echo "üìù Checking EditorConfig compliance..."
        # Check if .editorconfig exists and is properly configured
        if [ ! -f .editorconfig ]; then
          echo "‚ùå .editorconfig file not found!"
          exit 1
        fi
        echo "‚úÖ EditorConfig file found and will be enforced"

    - name: Verify code formatting
      run: |
        echo "üé® Verifying code formatting..."
        dotnet format --verify-no-changes --no-restore --verbosity diagnostic
        if [ $? -ne 0 ]; then
          echo ""
          echo "‚ùå Code formatting issues detected!"
          echo "üí° To fix locally, run: dotnet format"
          echo "üìù Or use the lint script: ./lint.ps1 (Windows) or ./lint.sh (Linux/macOS)"
          exit 1
        fi
        echo "‚úÖ All files are properly formatted"

    - name: StyleCop analysis
      run: |
        echo "üìè Running StyleCop analysis..."
        dotnet build --configuration Release --no-restore \
          --verbosity normal \
          -p:RunStyleCopAnalyzer=true \
          -p:StyleCopTreatErrorsAsWarnings=false
        echo "‚úÖ StyleCop analysis completed successfully"

    - name: Code analysis warnings check
      run: |
        echo "üîç Checking for code analysis warnings..."
        dotnet build --configuration Release --no-restore \
          --verbosity normal \
          -p:TreatWarningsAsErrors=false \
          -p:WarningsAsErrors="" \
          2>&1 | tee build-output.txt
          
        # Check for specific analyzer warnings
        if grep -q "warning CA\|warning SA\|warning S[0-9]" build-output.txt; then
          echo "‚ö†Ô∏è Code analysis warnings detected:"
          grep "warning CA\|warning SA\|warning S[0-9]" build-output.txt || true
          echo ""
          echo "üí° Please address these warnings before merging"
          echo "üìñ Refer to LINTING-README.md for guidance"
        else
          echo "‚úÖ No code analysis warnings detected"
        fi

    - name: Generate PR comment
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const jobStatus = '${{ job.status }}';
          
          let comment = `## üîç Code Quality Check Results\n\n`;
          
          if (jobStatus === 'success') {
            comment += `‚úÖ **All code quality checks passed!**\n\n`;
            comment += `### ‚úÖ Checks Completed:\n`;
            comment += `- üé® **Code Formatting**: All files properly formatted\n`;
            comment += `- üìè **StyleCop Rules**: Style guidelines followed\n`;
            comment += `- üîç **Code Analysis**: No warnings detected\n`;
            comment += `- üìù **EditorConfig**: Configuration compliance verified\n\n`;
            comment += `üéâ **This PR is ready for review!**\n`;
          } else {
            comment += `‚ùå **Code quality checks failed**\n\n`;
            comment += `Please check the workflow logs above and fix the issues.\n\n`;
            comment += `### üõ†Ô∏è How to fix locally:\n`;
            comment += `\`\`\`bash\n`;
            comment += `# Run the linting script\n`;
            comment += `./lint.ps1  # Windows\n`;
            comment += `./lint.sh   # Linux/macOS\n\n`;
            comment += `# Or manually:\n`;
            comment += `dotnet restore\n`;
            comment += `dotnet format\n`;
            comment += `dotnet build\n`;
            comment += `\`\`\`\n\n`;
            comment += `üìñ For more details, check [LINTING-README.md](./LINTING-README.md)\n`;
          }
          
          // Find existing comment to update or create new one
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const existingComment = comments.find(comment => 
            comment.body.includes('Code Quality Check Results')
          );
          
          if (existingComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }

  security-scan:
    name: Security Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Check for vulnerable packages
      run: |
        echo "üîí Scanning for vulnerable packages..."
        dotnet list package --vulnerable --include-transitive 2>&1 | tee security-report.txt
        
        if grep -q "has the following vulnerable packages" security-report.txt; then
          echo "‚ùå Vulnerable packages detected!"
          cat security-report.txt
          echo ""
          echo "üõ°Ô∏è Please update the following packages to secure versions:"
          grep -A 10 "vulnerable packages" security-report.txt || true
          exit 1
        else
          echo "‚úÖ No vulnerable packages found"
        fi

    - name: Upload security report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.txt

  changed-files-lint:
    name: Lint Changed Files Only
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          **/*.cs
          **/*.csproj
          **/*.props
          **/*.targets
          **/*.json
          **/*.yml
          **/*.yaml

    - name: Setup .NET 8
      if: steps.changed-files.outputs.any_changed == 'true'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      if: steps.changed-files.outputs.any_changed == 'true'
      run: dotnet restore

    - name: Lint changed C# files
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "üéØ Linting only changed files..."
        echo "Changed files:"
        echo "${{ steps.changed-files.outputs.all_changed_files }}"
        
        # Format only changed files
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          if [[ $file == *.cs ]]; then
            echo "üìù Checking: $file"
            dotnet format --include "$file" --verify-no-changes --no-restore
          fi
        done
        
        echo "‚úÖ All changed files pass linting checks"

    - name: No changes detected
      if: steps.changed-files.outputs.any_changed != 'true'
      run: |
        echo "‚ÑπÔ∏è No relevant files changed in this PR"
        echo "‚úÖ Linting checks skipped"
